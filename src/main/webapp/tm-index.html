<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>
<head>
    <title>Ticket Monster</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0;">

    <link type="text/css" rel="stylesheet" href="resources/css/screen.css"/>
    <link rel="stylesheet" href="resources/css/jquery-ui-1.8.17.custom.css" type="text/css" media="all"/>
    <script type="text/javascript" src="resources/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="resources/js/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript" src="resources/js/underscore.js"></script>
    <script type="text/javascript" src="resources/js/backbone.js"></script>
    <script type="text/javascript" src="resources/js/tm-utils.js"></script>
    <script type="text/javascript">
        $.ajax({
            url:"resources/templates/templates.tmpl",
            dataType:"text",
            context:document.head,
            success:function (data) {
                $(this).append(data);
            }
        });
    </script>

</head>
<body>

<div id="container">
    <div id="menu">
        <table>
            <tr>
                <td><a href="#events">Events</a></td>
                <td><a href="#venues">Venues</a></td>
                <td><a href="#bookings">Bookings</a></td>
                <td><a href="#about">About</a></td>
            </tr>
        </table>
    </div>
    <div id="content">

    </div>
</div>


<footer>
    <img src="resources/gfx/logo.png" alt="HTML5"/>
</footer>


<script type="text/javascript">
$("a").button();

TicketMonster = new Object()
TicketMonster.views = new Object()
TicketMonster.models = new Object()

TicketMonster.eventBus = _.extend({}, Backbone.Events);


var summaryView = null


TicketMonster.Event = Backbone.Model.extend({
    urlRoot:'rest/events'
})

TicketMonster.Events = Backbone.Collection.extend({
    url:"rest/events",
    model:TicketMonster.Event,
    id:"id",
    comparator:function (model) {
        return model.get('category').id;
    }
});

TicketMonster.MainView = Backbone.View.extend({
    render:function (data) {
        applyTemplate($(this.el), $('#main-view'), {})
        summaryView = new TicketMonster.EventSummaryView();
        $("#eventSummary").append(summaryView.render().el)
        this.menuView = new TicketMonster.MenuView({el:$("#eventMenu")});
        this.menuView.render(data)
    }
})

TicketMonster.MenuView = Backbone.View.extend({
    tagName:'div',
    render:function (data) {
        var viewRoot = $(this.el)
        viewRoot.empty()
        var current_category = null
        _.each(data, function (event) {
            var model_category = event.get('category')
            if (current_category !== model_category.id) {
                viewRoot.append(renderTemplate($('#category-title'), model_category));
                current_category = model_category.id;
            }
            var view = new TicketMonster.EventSummaryLineView({model:event});
            viewRoot.append(view.render().el);
        })
        $(this.el).accordion()
        $(this.el).accordion("option", "navigation", "true")
        return this
    }
});


TicketMonster.EventSummaryLineView = Backbone.View.extend({
    tagName:'div',
    events:{
        "click":"notify"
    },
    render:function () {
        applyTemplate($(this.el), $("#event-summary"), this.model.attributes)
        return this;
    },
    notify:function () {
        summaryView.render(this.model)
    }
})

TicketMonster.EventSummaryView = Backbone.View.extend({
    render:function (data) {
        if (data) {
            applyTemplate($(this.el), $("#event-summary-view"), data.attributes)
        }
        else {
            $(this.el).empty()
            $(this.el).append("Click a link on the left")
        }
        return this
    }
})

TicketMonster.EventDetailView = Backbone.View.extend({
    events:{
        "click input[name='bookButton']":"beginBooking",
        "change select[id='venueSelector']":"refreshShows"
    },
    render:function (model) {
        $(this.el).empty()
        applyTemplate($(this.el), $("#event-detail"), model.attributes)
        var self = this
        $.getJSON("rest/shows?event=" + model.get('id'), function (shows) {
            self.shows = shows
            $("#venueSelector").empty()
            $.each(shows, function (i, show) {
                $("#venueSelector").append("<option value='" + show.id + "'>" + show.venue.address.city + " : " + show.venue.name + "</option>")
            })
            if ($("#venueSelector").val()) {
                $("#venueSelector").change()
            }
        })
    },
    beginBooking:function () {
        tmRouter.navigate('/book/' + $("#venueSelector option:selected").val() + '/' + $("#performanceTimes").val(), true)
    },
    refreshShows:function (event) {
        var selectedShowId = event.currentTarget.value;
        var selectedShow = _.find(this.shows, function (show) {
            return show.id == selectedShowId
        });

        $("#dayPicker").datepicker("destroy")
        $("#dayPicker").datepicker({
            beforeShowDay:function (date) {
                return [_.any(selectedShow.performances, function (performance) {
                    return _.isEqual(new Date(performance.date).toCalendarDate(), date.toCalendarDate())
                }), "*", "Performance on this date"]
            },
            onSelect:function (dateText, inst) {
                var date = $(this).datepicker('getDate');
                $("#performanceTimes").empty()
                if (selectedShow) {
                    $.each(selectedShow.performances, function (i, performance) {
                        var performanceDate = new Date(performance.date);
                        if (_.isEqual(performanceDate.toCalendarDate(), date.toCalendarDate())) {
                            $("#performanceTimes").append("<option value='" + performance.id + "'>" + performanceDate.getHours().toZeroPaddedString(2) + ":" + performanceDate.getMinutes().toZeroPaddedString(2) + "</option>")
                        }
                    })
                }
            },
            defaultDate:null,
            minDate:new Date(selectedShow.performances[0].date),
            maxDate:new Date(selectedShow.performances[selectedShow.performances.length - 1].date),
            autoSize:false

        });
        $("#dayPicker").datepicker("setDate", null);
    }

})

TicketMonster.Booking = Backbone.Model.extend({
    urlRoot:'rest/bookings'
})

TicketMonster.Bookings = Backbone.Collection.extend({
    url:'rest/bookings',
    model:TicketMonster.Booking,
    id:'id'
})

TicketMonster.BookingView = Backbone.View.extend({
    events:{
        "click input[name='delete']":"delete"
    },
    render:function () {
        applyTemplate($(this.el), $("#booking-row"), this.model.attributes)
        return this;
    },
    delete:function () {
        if (confirm("Are you sure you want to delete booking " + this.model.get('id'))) {
            var self = this
            this.model.destroy()
        }
    }
})

TicketMonster.TicketSummaryView = Backbone.View.extend ({
  render: function() {
    applyTemplate($(this.el), $('#ticket-summary-view'), this.model.bookingRequest)
  }
})

TicketMonster.BookingsView = Backbone.View.extend({
    render:function (bookings) {
        $(this.el).empty().append("<table id='bookingDetails'/>");
        _.each(bookings, function (booking) {
            var bookingView = new TicketMonster.BookingView({model:booking})
            $("#bookingDetails").append(bookingView.render().el)
        })
    }
})

TicketMonster.BookingRequest = Backbone.Model.extend({

});

TicketMonster.AllocationRequest = Backbone.Model.extend({

});

TicketMonster.SectionSelectorView = Backbone.View.extend({
    render:function () {
        var self = this;
        applyTemplate($(this.el), $("#select-section"), { sections:_.uniq(_.sortBy(_.pluck(self.model.priceCategories, 'section'), function (item) {
            return item.id
        }), true, function (item) {
            return item.id
        })})
        return this
    }
});

TicketMonster.TicketCategoryView = Backbone.View.extend({
    events:{
        "change input":"onChange"
    },
    render:function () {
        applyTemplate($(this.el), $('#ticket-entry'), this.model.attributes);
        return this;
    },
    onChange:function (event) {
        var value = event.currentTarget.value;
        if (value != '' && value != 0) {
            this.model.set('quantity', parseInt(value))
        }
        else {
            this.model.unset('quantity')
        }
    }
});


TicketMonster.TicketCategoriesView = Backbone.View.extend({

    id:'categoriesView',
    render:function () {
        var views = {};

        if (this.model != null) {
        var priceCategories = _.map(this.model.models, function (item) {
            return item.attributes.priceCategory
        })
        applyTemplate($(this.el), $('#ticket-entries'), {priceCategories:priceCategories});

        _.each(this.model.models, function (model) {
            $("#ticket-category-input-" + model.attributes.priceCategory.id).append(new TicketMonster.TicketCategoryView({model:model}).render().el);

        });
        } else {
            $(this.el).empty()
        }
        return this;
    },
    updateModel:function () {

    }
});

TicketMonster.PriceCategoryQuantity = Backbone.Model.extend({

    initialize:function () {
        this.bind("change", this.onChange)
    },
    onChange:function () {
        if (!this.hasChanged('quantity'))
            return;
    }
});

TicketMonster.SectionQuantities = Backbone.Collection.extend({
    initialize:function () {
        this.on("change", function () {
            var sectionAggregate = _.reduce(this.models, function (aggregate, model) {
                if (model.get('quantity') != null) {
                    return {tickets:(aggregate.tickets + model.get('quantity')),
                        price:(aggregate.price + model.get('priceCategory').price * model.get('quantity'))}
                }
                return aggregate;
            }, {tickets:0, price:0});
        })

    }
});

TicketMonster.CreateBookingView = Backbone.View.extend({
    events:{
        "click input[name='submit']":"save",
        "change select":"refreshPrices",
        "click input[name='add']":"addQuantities"
    },
    render:function () {

        var self = this;
        $.getJSON("rest/shows/" + this.model.showId, function (selectedShow) {

            applyTemplate($(self.el), $("#create-booking"), { show:selectedShow,
                performance:_.find(selectedShow.performances, function (item) {
                    return item.id == self.model.performanceId
                })});
            self.selectorView = new TicketMonster.SectionSelectorView({model:selectedShow, el:$("#sectionSelectorPlaceholder")}).render();
            self.ticketCategoriesView = new TicketMonster.TicketCategoriesView({model:{}, el:$("#ticketCategoriesViewPlaceholder") });
            self.ticketSummaryView = new TicketMonster.TicketSummaryView({model:self.model, el:$("#ticketSummaryView")});
            self.show = selectedShow;
            self.ticketCategoriesView.render();
            $("#sectionSelector").change();
        });
    },
    refreshPrices:function (event) {
        var priceCategories = _.filter(this.show.priceCategories, function (item) {
            return item.section.id == event.currentTarget.value
        })
        var models = new Array()
        _.each(priceCategories, function (priceCategory) {
            var model = new TicketMonster.PriceCategoryQuantity()
            model.set('priceCategory', priceCategory)
            models.push(model)
        })
        this.ticketCategoriesView.model = new TicketMonster.SectionQuantities(models);
        this.ticketCategoriesView.render();
    },
    save:function (event) {
        var bookingRequest = {ticketRequests:[]};
        _.each(this.model.bookingRequest.tickets, function(collection){
            _.each(collection.models, function(model) {
               if (model.attributes.quantity != undefined) {
                  bookingRequest.ticketRequests.push({priceCategory:model.attributes.priceCategory.id, quantity:model.attributes.quantity})
               }
            })
        })

        bookingRequest.email = $("input[name='email']").val();
        bookingRequest.performance = this.model.performanceId
        $.ajax({url:"rest/bookings",
            data:JSON.stringify(bookingRequest),
            type:"POST",
            dataType:"json",
            contentType:"application/json",
                success:function (booking) {
                    $("#content").empty()

                    $("#content").append("Created booking " + booking.id + " with tickets as follows: ")
                    $.each(booking.allocations, function (i, allocation) {
                        if (allocation.quantity > 1) {
                            $("#content").append("<p/> Section " + allocation.row.section.name + " Row " + allocation.row.name + ", seats " + allocation.startSeat + "-" + allocation.endSeat)
                        } else {
                            $("#content").append("<p/> Section " + allocation.row.section.name + " Row " + allocation.row.name + ", seat " + allocation.startSeat)
                        }
                        $.each(allocation.ticketsPerCategory, function (i, entry) {
                            $("#content").append("<p/> " + entry.ticketCount + " " + entry.ticketCategory.description)
                        })
                    })

                }}).error(function (error) {
                    alert(error)
                })
        this.model.clear()
    },
    addQuantities:function (event) {
        this.model.bookingRequest.tickets.push(this.ticketCategoriesView.model)
        this.ticketCategoriesView.model = null
        $('option:selected', 'select').removeAttr('selected')
        this.ticketCategoriesView.render()
        this.selectorView.render();
        this.ticketSummaryView.render();
        $('input[name="submit"]').removeAttr('disabled')
    }
});


TicketMonster.AboutView = Backbone.View.extend({
    render:function () {
        $(this.el).empty().append("<section><h1>Welcome to Ticket Monster!</h1>" +
                "Ticket Monster is a demo application</section>")
    }
});

TicketMonster.Router = Backbone.Router.extend({
    routes:{
        "events":"events",
        "events/:id":"eventDetail",
        "about":"about",
        "book/:showId/:performanceId":"bookTickets",
        "bookings":"listBookings",
        "ignore":"ignore",
        "*actions":"defaultHandler"
    },
    initialize:function () {
        TicketMonster.views.mainView = new TicketMonster.MainView({el:$("#content")})
        TicketMonster.views.aboutView = new TicketMonster.AboutView({el:$("#content")})
        TicketMonster.views.eventDetailView = new TicketMonster.EventDetailView({el:$("#content")})
        TicketMonster.views.bookingsView = new TicketMonster.BookingsView({el:$("#content")})
        TicketMonster.models.events = new TicketMonster.Events;
        TicketMonster.models.bookings = new TicketMonster.Bookings;
        TicketMonster.models.events.bind("reset", function () {
            TicketMonster.views.mainView.render(this.models)
        })
        TicketMonster.models.bookings.bind("reset", function () {
            TicketMonster.views.bookingsView.render(this.models)
        })
        TicketMonster.models.bookings.bind("destroy", function () {
            this.fetch()
        })
    },
    events:function () {
        TicketMonster.models.events.fetch()
    },
    about:function () {
        TicketMonster.views.aboutView.render()
    },
    bookTickets:function (showId, performanceId) {
        var createBookingView = new TicketMonster.CreateBookingView({model:{showId:showId, performanceId:performanceId, bookingRequest:{tickets:[]}}, el:$("#content")})
        createBookingView.render()
    },
    listBookings:function () {
        TicketMonster.models.bookings.fetch()
    },
    eventDetail:function (id) {
        var model = new TicketMonster.Event({id:id})
        model.bind("change", function () {
            TicketMonster.views.eventDetailView.render(this)
        })
        model.fetch()
    }
});

var tmRouter = new TicketMonster.Router;

Backbone.history.start();

</script>

</body>
</html>