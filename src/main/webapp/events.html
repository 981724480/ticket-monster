<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>
<head>
    <title>Event viewer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script type="text/javascript" src="resources/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="resources/js/jquery-ui-1.8.14.custom.min.js"></script>
    <script type="text/javascript">
        function updateEvents() {
            $.getJSON("rest/events", function (events) {
                var eventListContent = '';
                $.each(events, function (i, event) {
                    eventListContent += ("<tr onclick='loadEventShowDetails(" + event.id + ")'>")
                    eventListContent += "<td>" + event.name + "</td>"
                    eventListContent += "<td>" + event.category.description + "</td>"
                    eventListContent += "</tr>"
                })
                $("#events").empty().append(eventListContent)

            })
        }
        var loadedShows = null
        var loadedSections = null
        var loadedPrices = null
        function loadEventShowDetails(eventId) {
            $.getJSON("rest/events/" + eventId, function (event) {
                $("#eventDetails").empty()
                $("#eventDetails").append("<img src='rest/media/" + event.picture.id + "'/><p/>" + event.description)
            })
            $.getJSON("rest/shows?event=" + eventId, function (shows) {
                loadedShows = new Object()
                $("#venueSelectorDiv").empty().append("<select id='venueSelector' />")
                $.each(shows, function (i, show) {
                    $("#venueSelector").append("<option value='" + show.id + "'>" + show.venueLayout.venue.name + "</option>")
                    loadedShows[show.id] = show
                })
                $("#venueSelector").change(function (selectElement) {
                    var showId = $("#venueSelector option:selected").val();
                    var selectedShow = loadedShows[showId];
                    $("#performanceTimeSelectorDiv").empty().append("<select id='performanceTimes'/>")
                    if (selectedShow) {

                        $.each(selectedShow.performances, function (i, performance) {
                            $("#performanceTimes").append("<option value='" + performance.id + "'>" + new Date(performance.date).toDateString() + "</option>")
                        })
                    }
                    if ($("#performanceTimes").val) {
                        $("#book").empty().append("<input type='button' onclick='beginBookTicket()' value='Book'/>");
                    }

                })
                if ($("#venueSelector").val) {
                    $("#venueSelector").change()
                }
                if ($("#performanceTimes").val) {
                    $("#book").empty().append("<input type='button' onclick='beginBookTicket()' value='Book'/>");
                }
            })
        }

        function checkAvailability(sectionId) {
            var quantity = 0
            var ticketInputs = $("#booking" + sectionId + ">input[type='number']");
            var priceIds = $("#booking" + sectionId + ">input[name='priceCategories']");
            var sectionPrice = 0
            $.each(ticketInputs, function(i, element) {
                if (''!== element.value) {
                    quantity += parseInt(element.value);
                    sectionPrice += quantity*loadedPrices[priceIds[i].value]
                }
            })
            if ('' === quantity || quantity == 0) {
                $("#sectionQuantity" + sectionId).empty()
                return
            }
            $("#sectionQuantity" + sectionId).empty().append(quantity.toString() + " for " + sectionPrice)
            $.getJSON("rest/availability", {"performance":$("#performanceTimes").val(),"quantity":quantity,"section":sectionId}, function(result) {
                var divId = "#sectionAvailability"+sectionId;
               $(divId).empty().append(result?"<div style='color:#00FF00'>available</div>":"<div style='color:#FF0000'>unavailable</div>")
            })
        }

        function beginBookTicket(performanceId) {
            loadedSections = new Object()
            loadedPrices = new Object()
            if ($("#performanceTimes").val()) {
                $("#book").empty();
                $("#book").append("<form id='bookTickets' name='bookTickets'/>");
                var showId = $("#venueSelector option:selected").val();
                var selectedShow = loadedShows[showId];
                $.getJSON("rest/venues/layouts/" + selectedShow.venueLayout.id + "/sections", function (sections) {
                     sections.forEach(function(section){
                         loadedSections[section.id] = section
                     })
                })
                $.getJSON("rest/shows/" + selectedShow.id + "/pricing", function (pricingMap) {
                    for (sectionId in pricingMap)  {
                        $("#bookTickets").append("<fieldset id='booking" + sectionId +"'><legend>"+loadedSections[sectionId].name+"</legend><div id='sectionQuantity"+ sectionId + "'/> <div id='sectionAvailability"+ sectionId + "'/> </fieldset>");
                    $.each(pricingMap[sectionId], function (i, price_category) {
                        $("#booking" + sectionId).append(price_category.ticketCategory.description + "(" + price_category.price + ")"+ ": <input type='number' name='tickets' min='0' onkeyup='checkAvailability("+sectionId+")' title='Numeric value'/> " +
                                " <input type='hidden' name='priceCategories' value='"+price_category.id+"'/>" +
                                " <input type='hidden' name='sections' value='"+sectionId+"'/>" +
                                " <p/>")
                        loadedPrices[price_category.id] = price_category.price
                    })
                    }

                    $("#bookTickets").append("Email: <input type='email' name='email' required/>");
                    $("#bookTickets").append("<input type='hidden' name='performance' value='"+ $("#performanceTimes").val()+ "'/>")
                    $("#bookTickets").append("<input name='createBooking' type='submit' value='Book!'/>")
                    $("#bookTickets").submit(function(event) {
                        event.preventDefault()
                        $.post("rest/bookings", $(this).serialize(), function(booking) {
                            $("#book").empty()

                            $("#book").append("Created booking " + booking.id + " with tickets as follows: ")
                            $.each(booking.allocations, function(i, allocation) {
                                if (allocation.quantity > 1) {
                                   $("#book").append("<p/> Section " + allocation.row.section.name + " Row " + allocation.row.name + ", seats " + allocation.startSeat + "-" + allocation.endSeat)
                                } else {
                                    $("#book").append("<p/> Section " + allocation.row.section.name + " Row " + allocation.row.name + ", seat " + allocation.startSeat)
                                }
                                $.each(allocation.ticketsPerCategory, function(i, entry){
                                    $("#book").append("<p/> " + entry.ticketCount + " " + entry.ticketCategory.description)
                                })
                            })

                        }).error(function(error) {

                     })
                    })
                })
            }
            else {
               alert("nothing selected")
            }
        }
        $(document).ready(function () {
            updateEvents();
        });

    </script>
</head>
<body>
<div>
    <div>
        <table border="true">
            <thead>
            <tr>
                <td>Event name</td>
                <td>Category</td>
            </tr>
            </thead>
            <tbody id="events">
            <tr>
                <td>Loading!</td>
            </tr>
            </tbody>
        </table>
    </div>
    <div id="eventDetails">

    </div>


    <div id="venueSelectorDiv">

    </div>

    <div id="performanceTimeSelectorDiv">

    </div>

    <div id="book">

    </div>
</div>
</body>
</html>