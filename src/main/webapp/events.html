<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>
<head>
    <title>Event viewer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script type="text/javascript" src="resources/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="resources/js/jquery-ui-1.8.14.custom.min.js"></script>
    <script type="text/javascript">
        function updateEvents() {
            $.getJSON("rest/events", function (events) {
                var eventListContent = '';
                $.each(events, function (i, event) {
                    eventListContent += ("<tr onclick='loadEventShowDetails(" + event.id + ")'>")
                    eventListContent += "<td>" + event.name + "</td>"
                    eventListContent += "<td>" + event.category.description + "</td>"
                    eventListContent += "</tr>"
                })
                $("#events").empty().append(eventListContent)

            })
        }
        var loadedShows = null
        function loadEventShowDetails(eventId) {
            $.getJSON("rest/events/" + eventId, function (event) {
                $("#eventDetails").empty()
                $("#eventDetails").append("<img src='rest/media/" + event.picture.id + "'/><p/>" + event.description)
            })
            $.getJSON("rest/shows?event=" + eventId, function (shows) {
                loadedShows = new Object()
                $("#venueSelectorDiv").empty().append("<select id='venueSelector' />")
                $.each(shows, function (i, show) {
                    $("#venueSelector").append("<option value='" + show.id + "'>" + show.venue.name + "</option>")
                    loadedShows[show.id] = show
                })
                $("#venueSelector").change(function (selectElement) {
                    var showId = $("#venueSelector option:selected").val();
                    var selectedShow = loadedShows[showId];
                    $("#performanceTimeSelectorDiv").empty().append("<select id='performanceTimes'/>")
                    if (selectedShow) {

                        $.each(selectedShow.performances, function (i, performance) {
                            $("#performanceTimes").append("<option value='" + performance.id + "'>" + new Date(performance.date).toDateString() + "</option>")
                        })
                    }
                    if ($("#performanceTimes").val) {
                        $("#book").empty().append("<input type='button' onclick='beginBookTicket()' value='Book'/>");
                    }

                })
                if ($("#venueSelector").val) {
                    $("#venueSelector").change()
                }
                if ($("#performanceTimes").val) {
                    $("#book").empty().append("<input type='button' onclick='beginBookTicket()' value='Book'/>");
                }
            })
        }
        function beginBookTicket(performanceId) {
            if ($("#performanceTimes").val()) {
                $("#book").empty();
                $("#book").append("<form id='bookTickets' name='bookTickets'/>");
                var showId = $("#venueSelector option:selected").val();
                var selectedShow = loadedShows[showId];
                $.getJSON("rest/venues/layouts/" + selectedShow.venueLayout.id + "/sections", function (sections) {
                    $.each(sections, function (i, section) {
                        $("#bookTickets").append("Section " + section.name + ": <input type='number' name='tickets' min='0'  title='Numeric value'/>" +
                                "<input type='hidden' name='sections' value='"+section.id+"'/<p/>")
                    })

                    $("#bookTickets").append("Email: <input type='email' name='email' required/>");
                    $("#bookTickets").append("<input type='hidden' name='performance' value='"+ $("#performanceTimes").val()+ "'/>")
                    $("#bookTickets").append("<input name='createBooking' type='submit' value='Book!'/>")
                    $("#bookTickets").submit(function(event) {
                        event.preventDefault()
                        $.post("rest/bookings", $(this).serialize(), function(booking) {
                            $("#book").empty()

                            $("#book").append("Booked ticket " + booking.id + " as follows: ")
                            $.each(booking.allocations, function(i, allocation) {
                                if (allocation.quantity > 1) {
                                   $("#book").append("<p/> Section " + allocation.row.section.name + " Row " + allocation.row.name + ", seats " + allocation.startSeat + "-" + allocation.endSeat)
                                } else {
                                    $("#book").append("<p/> Section " + allocation.row.section.name + " Row " + allocation.row.name + ", seat " + allocation.startSeat)
                                }
                            })

                        }).error(function(error) {

                     })
                    })
                })
            }
            else {
               alert("nothing selected")
            }
        }
        $(document).ready(function () {
            updateEvents();
        });

    </script>
</head>
<body>
<div>
    <div>
        <table border="true">
            <thead>
            <tr>
                <td>Event name</td>
                <td>Category</td>
            </tr>
            </thead>
            <tbody id="events">
            <tr>
                <td>Loading!</td>
            </tr>
            </tbody>
        </table>
    </div>
    <div id="eventDetails">

    </div>


    <div id="venueSelectorDiv">

    </div>

    <div id="performanceTimeSelectorDiv">

    </div>

    <div id="book">

    </div>
</div>
</body>
</html>