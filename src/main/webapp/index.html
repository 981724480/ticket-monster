<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>
<head>
    <title>Ticket Monster</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="resources/css/screen.css"/>
    <link rel="stylesheet" href="resources/css/jquery-ui.css" type="text/css" media="all"/>

    <script type="text/javascript" src="resources/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="resources/js/jquery-ui-1.8.14.custom.min.js"></script>
    <script type="text/javascript" src="resources/js/underscore-min.js"></script>
    <script type="text/javascript" src="resources/js/backbone-min.js"></script>


</head>
<body>

<div id="container">
    <div id="menu">
        <table>
            <tr>
                <td><a href="#">Home</a></td>
                <td><a href="#/events">Events</a></td>
                <td><a href="#/venues">Venues</a></td>
                <td><a href="#/bookings">Bookings</a></td>
                <td><a href="#/about">About</a></td>
            </tr>
        </table>
    </div>
    <div id="content">

    </div>
</div>
<footer>
    <img src="resources/gfx/logo.png" alt="HTML5"/>
</footer>
<script type="text/javascript">
    TicketMonster = new Object()
    TicketMonster.views = new Object()
    TicketMonster.models = new Object()

    TicketMonster.eventBus = _.extend({}, Backbone.Events);

    var summaryView = null

    TicketMonster.Event = Backbone.Model.extend({
        urlRoot:'rest/events',
        initialize:function () {
            console.log("Creating an event")
        }
    })

    TicketMonster.Events = Backbone.Collection.extend({
        url:"rest/events",
        model:TicketMonster.Event,
        id:"id",
        comparator:function (model) {
            return model.get('category').id;
        }
    });

    TicketMonster.MainView = Backbone.View.extend({
        render:function (data) {
            $(this.el).empty().append("<table width='100%'><tr><td id='eventMenu' width='30%' valign='top'/><td id='eventSummary' width='70%'/></tr></table>")
            summaryView = new TicketMonster.EventSummaryView();
            $("#eventSummary").append(summaryView.render().el)
            this.menuView = new TicketMonster.MenuView();
            $("#eventMenu").append(this.menuView.el)
            this.menuView.render(data)


        }
    })

    TicketMonster.MenuView = Backbone.View.extend({
        tagName:'div',
        render:function (data) {
            $(this.el).empty().append('<div id="eventsAccordion"/>');

            var current_category = null
            _.each(data, function (event) {
                var model_category = event.get('category')
                if (current_category !== model_category.id) {
                    $("#eventsAccordion").append('<h3><a href="#">' + model_category.description + '</a></h3>');
                    current_category = model_category.id;
                }
                var view = new TicketMonster.EventSummaryLineView({model:event});
                $("#eventsAccordion").append(view.render().el);
            })
            $("#eventsAccordion").accordion()
            return this
        }
    });

    TicketMonster.EventSummaryLineView = Backbone.View.extend({
        tagName:'div',
        events:{
            "click":"notify"
        },
        render:function () {
            $(this.el).empty().append('<a href="#ignore">' + this.model.get('name') + '</a>')
            return this;
        },
        notify:function () {
            summaryView.render(this.model)
        }
    })

    TicketMonster.EventSummaryView = Backbone.View.extend({
        render:function (data) {
            if (data) {
                $(this.el).empty()
                $(this.el).append("<h1>" + data.get('name') + "</h1><p/><img src='rest/media/" + data.get('picture').id + "'/><p/>" + data.get("description"))
                $(this.el).append("<a href='#/events/" + data.get('id') + "'>Get details</a>")
            }
            else {
                $(this.el).empty()
                $(this.el).append("Click a link on the left")
            }
            return this
        }
    })

    TicketMonster.EventDetailView = Backbone.View.extend({
        render:function (model) {
            $(this.el).empty()
            $(this.el).append("<h1>" + model.get('name') + "</h1><p/><img src='rest/media/" + model.get('picture').id + "'/><p/>" + model.get("description"))

        }
    })


    TicketMonster.AboutView = Backbone.View.extend({
        render:function () {
            $(this.el).empty().append("<section><h1>Welcome to Ticket Monster!</h1>" +
                    "Ticket Monster is a demo application</section>")
        }
    })

    TicketMonster.Router = Backbone.Router.extend({
        routes:{
            "":"home",
            "/events":"home",
            "/events/:id":"eventDetail",
            "/about":"about",
            "/book/:id":"book",
            "ignore":"ignore",
            "*actions":"defaultHandler"
        },
        initialize:function () {
            TicketMonster.views.mainView = new TicketMonster.MainView({el:$("#content")})
            TicketMonster.views.aboutView = new TicketMonster.AboutView({el:$("#content")})
            TicketMonster.views.eventDetailView = new TicketMonster.EventDetailView({el:$("#content")})
            TicketMonster.models.events = new TicketMonster.Events;
            TicketMonster.models.events.bind("reset", function () {
                TicketMonster.views.mainView.render(this.models)
            })
        },
        home:function () {
            TicketMonster.models.events.fetch()
        },
        about:function () {
            TicketMonster.views.aboutView.render()
        },
        book:function (id) {
            alert("Booking for id")
        },
        eventDetail:function (id) {
            var model = new TicketMonster.Event({id:id})
            model.bind("change", function() {
                TicketMonster.views.eventDetailView.render(this)
            })
            model.fetch()
         },
        ignore:function () {
        },
        defaultHandler:function (actions) {
            alert(actions)
        }
    });


    var tmRouter = new TicketMonster.Router;

    Backbone.history.start();
</script>
</body>
</html>